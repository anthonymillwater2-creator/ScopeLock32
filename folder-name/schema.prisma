// ScopeLock V1 Database Schema
// Enforces all business rules at DB level

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// EDITORS
// ============================================

model Editor {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  createdAt DateTime @default(now())

  projects         Project[]
  activityEvents   ActivityEvent[]
  scopeOverrides   Note[]          @relation("ScopeOverrides")

  @@map("editors")
}

// ============================================
// PROJECTS
// ============================================

enum ProjectState {
  draft
  in_review
  awaiting_approval
  approved

  @@map("project_state")
}

enum PackageTier {
  basic
  standard
  premium
  custom

  @@map("package_tier")
}

enum RequestType {
  pacing_edit
  color_correction
  audio_mix
  text_overlay
  transition_change
  b_roll_addition
  effect_adjustment
  crop_reframe

  @@map("request_type")
}

model Project {
  id          String       @id @default(cuid())
  editorId    String       @map("editor_id")
  clientName  String       @map("client_name")
  clientEmail String       @map("client_email")

  // Package configuration
  packageTier        PackageTier    @map("package_tier")
  revisionCap        Int            @map("revision_cap")
  revisionUsed       Int            @default(0) @map("revision_used")
  allowedRequestTypes RequestType[] @map("allowed_request_types")

  // Scope descriptions (shown to client)
  scopeDescription String?        @map("scope_description") @db.Text

  // State machine
  state       ProjectState @default(draft)

  // Timestamps
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  approvedAt  DateTime?    @map("approved_at")

  // Relations
  editor          Editor           @relation(fields: [editorId], references: [id], onDelete: Cascade)
  reviewTokens    ReviewToken[]
  videoVersions   VideoVersion[]
  revisionRounds  RevisionRound[]
  activityEvents  ActivityEvent[]

  @@index([editorId])
  @@index([state])
  @@map("projects")
}

// ============================================
// REVIEW TOKENS (Magic Links)
// ============================================

model ReviewToken {
  id        String   @id @default(cuid())
  projectId String   @map("project_id")
  token     String   @unique @default(cuid())

  isActive  Boolean  @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")
  lastUsedAt DateTime? @map("last_used_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([projectId, isActive])
  @@map("review_tokens")
}

// ============================================
// VIDEO VERSIONS
// ============================================

model VideoVersion {
  id          String   @id @default(cuid())
  projectId   String   @map("project_id")
  versionNumber Int    @map("version_number")

  // External URL only (no file hosting)
  videoUrl    String   @map("video_url")

  // Optional metadata
  duration    Int?     // seconds
  notes       String?  @db.Text

  uploadedAt  DateTime @default(now()) @map("uploaded_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, versionNumber])
  @@index([projectId])
  @@map("video_versions")
}

// ============================================
// REVISION ROUNDS
// ============================================

enum RoundStatus {
  open
  submitted

  @@map("round_status")
}

model RevisionRound {
  id          String      @id @default(cuid())
  projectId   String      @map("project_id")
  roundNumber Int         @map("round_number")

  status      RoundStatus @default(open)

  openedAt    DateTime    @default(now()) @map("opened_at")
  submittedAt DateTime?   @map("submitted_at")

  // Which version this round was for
  videoVersionNumber Int? @map("video_version_number")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  notes   Note[]

  @@unique([projectId, roundNumber])
  @@index([projectId, status])
  @@map("revision_rounds")
}

// ============================================
// NOTES (Timestamped Feedback)
// ============================================

enum ScopeStatus {
  in_scope
  additional_request

  @@map("scope_status")
}

model Note {
  id              String   @id @default(cuid())
  revisionRoundId String   @map("revision_round_id")

  // Timestamp in video (seconds)
  timestamp       Int

  // Client input
  requestType     RequestType    @map("request_type")
  noteText        String         @map("note_text") @db.Text
  clientMarkedNewIdea Boolean    @default(false) @map("client_marked_new_idea")

  // Auto-generated scope classification
  scopeStatus     ScopeStatus    @map("scope_status")

  // Editor override (nullable)
  overrideTo      ScopeStatus?   @map("override_to")
  overrideReason  String?        @map("override_reason") @db.Text
  overrideEditorId String?       @map("override_editor_id")
  overrideAt      DateTime?      @map("override_at")

  createdAt       DateTime       @default(now()) @map("created_at")

  revisionRound   RevisionRound  @relation(fields: [revisionRoundId], references: [id], onDelete: Cascade)
  overrideEditor  Editor?        @relation("ScopeOverrides", fields: [overrideEditorId], references: [id])

  @@index([revisionRoundId])
  @@index([scopeStatus])
  @@map("notes")
}

// ============================================
// ACTIVITY LOG
// ============================================

enum ActivityEventType {
  project_created
  video_uploaded
  review_link_generated
  review_link_revoked
  revision_round_opened
  note_added
  revision_round_submitted
  scope_overridden
  project_approved

  @@map("activity_event_type")
}

model ActivityEvent {
  id        String            @id @default(cuid())
  projectId String            @map("project_id")
  editorId  String?           @map("editor_id")

  eventType ActivityEventType @map("event_type")
  metadata  Json?             // Additional event data

  createdAt DateTime          @default(now()) @map("created_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  editor  Editor? @relation(fields: [editorId], references: [id])

  @@index([projectId, createdAt])
  @@index([eventType])
  @@map("activity_events")
}
